volumes:
  furukawa-sample-postgresql-volume:
  furukawa-sample-nuxt-node_modules-volume:
  # sample-api-db-init:
  # sample-api-db-volume:
  # sample-api-hasura-volume:
  # # sample-myapp-volume:
  # # sample-sample-volume:
  # sample-nginx-conf-volume:
  # sample-nginx-sites-available-volume:
  # sample-nginx-log-volume:
  # sample-log-firelens-volume:

services:
  # ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ HasuraãŒæ°¸ç¶šåŒ–æ©Ÿæ§‹ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹PostgreSQL ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½
  furukawa-sample-postgresql:
    container_name: furukawa-sample-postgresql
    tty: true
    #platform: linux/x86_64
    image: postgres:15.4
    # ãƒ­ã‚°ã‚’è¦‹ãŸã‘ã‚Œã°â†“ã‚³ãƒžãƒ³ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    # command: postgres -c log_destination=stderr -c log_statement=all -c log_connections=on -c log_disconnections=on
    # log_statement = none: è¨˜éŒ²ã—ãªã„ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é€šå¸¸ã“ã‚Œã€‚
    # log_statement = ddl:  CREATEã€ALTERã€DROPãªã©ã®ãƒ‡ãƒ¼ã‚¿å®šç¾©æ–‡
    # log_statement = mod:  "ddl"ï¼‹INSERTã€UPDATEã€DELETEã€TRUNCATEã€COPY FROMãªã©ã€ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã‚‚ã®
    # log_statement = all:  ã™ã¹ã¦ã®SQLã‚’è¨˜éŒ²
    command: postgres -c log_destination=stderr -c log_statement=mod -c log_connections=off -c log_disconnections=off
    volumes:
      - ./furukawa-sample-postgresql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
      - furukawa-sample-postgresql-volume:/var/lib/postgresql/data
    environment:
      # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯æ—¥æœ¬ã«ã—ã¨ã
      TZ: "Asia/Tokyo"
      POSTGRES_USER: root
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: sample
      # POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-please-change-postgres-password}"
    ports:
      - "5432:5432"
    healthcheck:
      test: pg_isready --username root --dbname sample
      # test: pg_isready -U example_user -postgres-example-password
      interval: 3s
      timeout: 2s
      retries: 999999
    # depends_on:
    #   sample-log:
    #     condition: service_healthy

  # ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ Graphqlã‚µãƒ¼ãƒ(Hasura) ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½
  furukawa-sample-hasura:
    container_name: furukawa-sample-hasura
    build:
      context: ./furukawa-sample-hasura
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      furukawa-sample-postgresql:
        condition: service_healthy
      # sample-log:
      #   condition: service_healthy
    restart: always
    healthcheck:
      test: curl -X GET http://localhost:8080/healthz || exit 1
      interval: 3s # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯3ç§’ã«1åº¦ãã‚‰ã„ã«æŠ¼ã•ãˆã¦ãŠããŸã„
      timeout: 2s # å¿œç­”ãŒ2ç§’ä»¥ä¸Šã‹ã‹ã£ã¦ã‚‚è¨±ã•ãªã„
      retries: 999999 # 100å›žãã‚‰ã„å¤±æ•—å¿œç­”ã—ãŸã‚‰è¨±ã•ãªã„
    # logging:
    #   driver: 'fluentd'
    #   options:
    #     fluentd-address: '127.0.0.1:24224'
    #     fluentd-async-connect: 'true'
    #     tag: '*-firelens-*'

    volumes:
      - ./furukawa-sample-hasura/hasura:/hasura
    environment:
      # HasuraãŒåˆ©ç”¨ã™ã‚‹DBæŽ¥ç¶šå…ˆURL
      HASURA_GRAPHQL_DATABASE_URL: postgres://root:pass@furukawa-sample-postgresql:5432/sample

      # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›å…ˆã®DBæŽ¥ç¶šå…ˆURL(â€»è¨­å®šã—ãªã„å ´åˆã¯HASURA_GRAPHQL_DATABASE_URLã¨åŒã˜æŽ¥ç¶šå…ˆãŒä½¿ç”¨ã•ã‚Œã‚‹)
      # HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://root:pass@furukawa-sample-postgresql:5432/sample

      # DBã®æ“ä½œãŒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæœŸã•ã‚Œãªã„ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’èµ·å‹•å‡ºæ¥ã‚‹ã‹ã©ã†ã‹ï¼Ÿ
      # "true"ã«è¨­å®šã™ã‚‹ã¨http://localhost:8080/consoleã§æŽ¥ç¶šå‡ºæ¥ã‚‹URLã‚‚å±•é–‹ã•ã‚Œã‚‹ãŒ
      # ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å‹•ä½œã™ã‚‹ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯migrationãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæœŸç”ŸæˆãŒã•ã‚Œãªã„ã®ã§ä½¿ã‚ã›ãªã„(â€»ã‚„ã‚„ã“ã—ã„ã‹ã‚‰)
      HASURA_GRAPHQL_ENABLE_CONSOLE: "false"

      # ã“ã®ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚‹ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® errors ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« extensions ã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
      # ã“ã® internal ã‚­ãƒ¼ã«ã¯ã€ç”Ÿæˆã•ã‚ŒãŸSQLã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚„Postgresã‹ã‚‰ã®ä¾‹å¤–æƒ…å ±ãªã©ã®ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚
      # (â€»é–‹ç™ºä¸­ã®ã¿æœ‰åŠ¹ã«ã™ã‚‹ã¹ãã§ã€æœ¬ç•ªç’°å¢ƒã§ã¯ false ã«ã—ãªã„ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«ã«ãªã‚‹)
      HASURA_GRAPHQL_DEV_MODE: "true"

      # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š debug > info > warn > error
      HASURA_GRAPHQL_LOG_LEVEL: error

      # æœ‰åŠ¹åŒ–ã™ã‚‹ãƒ­ã‚°ã®ç¨®é¡ž
      # (â€»å‚è€ƒ https://hasura.io/docs/latest/deployment/logging/ )
      HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log

      ## uncomment next line to set an admin secret
      HASURA_GRAPHQL_ADMIN_SECRET: hogehoge

      # HASURA_GRAPHQL_ASYNC_ACTIONS_FETCH_BATCH_SIZE: ???

      # HASURAçµŒç”±ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™ºç«æ™‚ã«æ¸¡ã™æƒ…å ±
      HASURA_ACTION_SECRET_ENV: jojo
      HASURA_GRAPHQL_MIGRATIONS_DIR: /hasura/migrations
      HASURA_GRAPHQL_METADATA_DIR: /hasura/metadata

      # â†“ ã“ã†ã„ã†ã®ãŒã»ã—ã„ã‘ã©å­˜åœ¨ã—ãªã„
      # HASURA_GRAPHQL_URL_ROOT: api

      # Hasuraã‹ã‚‰å„ã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ã®WebHookã‚’é£›ã°ã™ãŸã‚ã®ãƒ™ãƒ¼ã‚¹URL
      NUXT_API_BASE_SCHEDULE: http://host.docker.internal:4200/myapp/api/webhook/schedule
      NUXT_API_BASE_EVENT: http://host.docker.internal:4200/myapp/api/webhook/event
      NUXT_API_BASE_SAMPLE: http://host.docker.internal:4100/sample/api/webhook/action
      NUXT_API_BASE_myapp: http://host.docker.internal:4200/myapp/api/webhook/action
      NUXT_API_BASE_COMPANY: http://host.docker.internal:4300/company/api/webhook/action
      NUXT_API_BASE_STUDENT: http://host.docker.internal:4400/student/api/webhook/action
      NUXT_API_BASE_ASSISTANT: http://host.docker.internal:4500/assistant/api/webhook/action

      # HASURA_GRAPHQL_AUTH_HOOK: http://172.29.0.1:8080/miniauth/api/auth
      # HASURA_GRAPHQL_AUTH_HOOK_MODE: POST

      # HASURA_GRAPHQL_CORS_DOMAIN: "https://*.foo.bar.com:8080, http://*.localhost, http://localhost:3000, http://example.com"
      HASURA_GRAPHQL_CORS_DOMAIN: "*"

      # CORS ãŒç„¡åŠ¹ãªå ´åˆã§ã‚‚ã€WebSocket ã®åˆæœŸãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã§ Cookie ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
      # ã“ã‚Œã¯æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ¬ é™¥ã¨ãªã‚Šå¾—ã¾ã™ã€‚è‡ªåˆ†ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      # ã“ã®è¨­å®šã¯ã€CORSãŒç„¡åŠ¹ãªå ´åˆã«ã®ã¿é©ç”¨ã•ã‚Œã¾ã™ã€‚
      # HASURA_GRAPHQL_WS_READ_COOKIE: true

  #     HASURA_GRAPHQL_JWT_SECRET: '{"claims_format":"json","audience":"http://local.sample.jp:4001/","claims_namespace":"https://hasura.io/jwt/claims","type":"HS256","key":"3jhgs8idsu9832GYas912tgaqsdjuidsDFVGTRiwi329jfdqiuehjfa","issuer":"http://local-api.sample.jp:8080/miniauth"}'

  # ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ Nuxt3 ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½ðŸ”½
  furukawa-sample-nuxt:
    # user: 1000:1000
    container_name: furukawa-sample-nuxt
    tty: true
    stdin_open: true
    build:
      context: ./furukawa-sample-nuxt
      dockerfile: Dockerfile
      target: dev
    healthcheck:
      # test: curl -I 127.0.0.1:2000/health_check
      test: lsof -i:2000
      interval: 3s # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯3ç§’ã«1åº¦ãã‚‰ã„ã«æŠ¼ã•ãˆã¦ãŠããŸã„
      timeout: 2s # å¿œç­”ãŒ2ç§’ä»¥ä¸Šã‹ã‹ã£ã¦ã‚‚è¨±ã•ãªã„
      retries: 999999 # 100å›žãã‚‰ã„å¤±æ•—å¿œç­”ã—ãŸã‚‰è¨±ã•ãªã„
      # start_period: 30s # ç«‹ã¡ä¸ŠãŒã‚‹ã®ã«ã€10ç§’ã‹ã‹ã‚Šãã†
      # args:
      #   - MODE_LOCAL=true
      #   - API_HOST=http://my-rails:3000
    ports:
      - "2000:2000"
    depends_on:
      furukawa-sample-hasura:
        condition: service_healthy
        # condition: service_started
    volumes:
      - ./furukawa-sample-nuxt:/app
      - furukawa-sample-nuxt-node_modules-volume:/app/node_modules
    environment:
      - NODE_ENV=development # ------------> ãƒ¢ãƒ¼ãƒ‰ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰(development) æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰(production)
      - NUXT_PUBLIC_DOCKER_MODE=true
      - NUXT_PUBLIC_SSR_MODE=true
      - NUXT_PUBLIC_API_HOST=furukawa-sample-hasura:8080
      - NUXT_PUBLIC_API_PROTOCOL=http
      - NUXT_PUBLIC_API_WS_PROTOCOL=ws
      - NUXT_PUBLIC_API_PATH=v1/graphql
      - NUXT_PUBLIC_API_PATH_RELAY=v1beta1/relay
      - NUXT_X_HASURA_ADMIN_SECRET=hogehoge
      - NUXT_X_HASURA_ACTION_SECRET=hogehoge
